     1                                  ; エントリーポイント
     2                                  
     3                                  BOOT_LOAD equ 0x7c00
     4                                  
     5                                  org BOOT_LOAD
     6                                  
     7                                  ; ****************************
     8                                  ; マクロ
     9                                  ; ****************************
    10                                  %include "../include/macro.s"
     1                              <1> %macro cdecl 1-*.nolist
     2                              <1>     
     3                              <1>     %rep %0 - 1
     4                              <1>         push %{-1:-1}
     5                              <1>         %rotate -1
     6                              <1>     %endrep
     7                              <1> 
     8                              <1>     %rotate -1
     9                              <1>         call %1
    10                              <1>     
    11                              <1>     %if 1 < %0
    12                              <1>         add sp, (__BITS__ >> 3) * (%0 - 1)
    13                              <1>     %endif
    14                              <1> 
    15                              <1> %endmacro
    11                                  
    12                                  ; ****************************
    13                                  ; エントリーポイント
    14                                  ; ****************************
    15                                  entry:
    16 00000000 EB58                        jmp ipl
    17                                  
    18                                      ; ---------
    19                                      ; BPB (BIOS Parameter Block)
    20                                      ; ---------
    21 00000002 90<rept>                    times 90 - ($ - $$) db 0x90
    22                                  
    23                                      ; ---------
    24                                      ; IPL(Initial Program Loader)
    25                                      ; --------- 
    26                                  
    27                                  ipl:
    28                                      ; BIOSが利用した時の値がそのまま残っているので、セグメントやスタックの値を設定しなおす
    29 0000005A FA                          cli ; セグメントの初期化や割り込みの設定時に割り込みが呼ばれてほしくないので、いったん止める
    30                                  
    31 0000005B B80000                      mov ax, 0x0000
    32 0000005E 8ED8                        mov ds, ax
    33 00000060 8EC0                        mov es, ax
    34 00000062 8ED0                        mov ss, ax
    35 00000064 BC007C                      mov sp, BOOT_LOAD ; スタックはブートローダーが読み込まれた場所から上に伸びていく
    36                                  
    37 00000067 FB                          sti ; 割り込みのうけつけを再開する
    38                                  
    39 00000068 8816[9C00]                  mov [BOOT.DRIVE], dl ; ドライブ番号の保存
    40                                  
    41 0000006C 6A58E8150083C402            cdecl putc, word 'X'
    42 00000074 6A59E80D0083C402            cdecl putc, word 'Y'
    43 0000007C 6A5AE8050083C402            cdecl putc, word 'Z'
    44                                  
    45 00000084 EBFE                        jmp $
    46                                  
    47                                  ; ****************************
    48                                  ; モジュール
    49                                  ; ****************************
    50                                  %include "../modules/real/putc.s"
     1                              <1> ; putc
     2                              <1> ; @params ch (2 bytes) 文字コード
     3                              <1> ; @returns void
     4                              <1> putc:
     5                              <1>     ; スタックフレームの構築
     6 00000086 55                  <1>     push bp
     7 00000087 89E5                <1>     mov bp, sp
     8                              <1> 
     9                              <1>     ;+ 4 | 出力文字
    10                              <1>     ;+ 2 | IP
    11                              <1>     ;+ 0 | BP
    12                              <1> 
    13                              <1>     ; レジスタの保存
    14 00000089 50                  <1>     push ax
    15 0000008A 53                  <1>     push bx
    16                              <1> 
    17 0000008B 8A4604              <1>     mov al, [bp + 4]
    18 0000008E B40E                <1>     mov ah, 0x0e
    19 00000090 BB0000              <1>     mov bx, 0x0000
    20 00000093 CD10                <1>     int 0x10
    21                              <1> 
    22                              <1>     ; レジスタの復帰
    23 00000095 5B                  <1>     pop bx
    24 00000096 58                  <1>     pop ax
    25                              <1> 
    26                              <1>     ; スタックフレームの破棄
    27 00000097 89EC                <1>     mov sp, bp
    28 00000099 5D                  <1>     pop bp
    29                              <1> 
    30 0000009A C3                  <1>     ret
    51                                  
    52 0000009B 00                      ALIGN 2, db 0
    53                                  BOOT: ; ブートドライブに関する情報
    54 0000009C 0000                        .DRIVE dw 0 ; ドライブ番号
    55                                  
    56                                  
    57 0000009E 00<rept>                    times 510 - ($ - $$) db 0x00
    58 000001FE 55AA                        db 0x55, 0xaa
